<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Team Roster Viewer</title>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; background:#e7effa; color:#333; padding:1rem; }
    h1 { text-align:center; margin-bottom:.5rem; }
    .legend, .controls { display:flex; flex-wrap:wrap; gap:8px; justify-content:center; margin-bottom:1rem; }
    .legend-item, .controls input, .controls select, .controls button {
      padding:4px 8px; font-size:.9rem;
    }
    table { margin:0 auto; border-collapse:collapse; width:95%; }
    th, td { border:1px solid #aaa; padding:5px; text-align:center; font-size:.85rem; }
    th { background:#003366; color:#fff; position:sticky; top:0; }
    /* shift colours */
    .shift-6   { background:#c0ffc0 } /* Day:   06:00–16:00 */
    .shift-15  { background:#b3d9ff } /* Aft:   15:00–01:00 */
    .shift-16  { background:#add8e6 } /* Late:  16:00–02:00 */
    .shift-17  { background:#e3b3ff } /* Even:  17:00–03:00 */
    .shift-18  { background:#d3d3ff } /* Night: 18:00–07:00 (or adjust code if needed) */
    .shift-X   { background:#f5f5f5 } /* Off */
    .shift-AL  { background:#ffff99 }
    .shift-CT  { background:#ffcc66 }
    .shift-T   { background:#dda0dd }
    .shift-RDO { background:#ffcccc }
    .shift-LSL { background:#ccffcc }
    .shift-RS  { background:#99ccff }
  </style>
</head>
<body>
  <h1>Team Roster Viewer</h1>

  <div class="legend">
    <div class="legend-item shift-6">6—Day (06:00–16:00)</div>
    <div class="legend-item shift-15">15—Afternoon (15:00–01:00)</div>
    <div class="legend-item shift-16">16—Late (16:00–02:00)</div>
    <div class="legend-item shift-17">17—Evening (17:00–03:00)</div>
    <div class="legend-item shift-18">18—Night (18:00–07:00)</div>
    <div class="legend-item shift-X">X—Off</div>
    <div class="legend-item shift-AL">AL—Annual Leave</div>
    <div class="legend-item shift-CT">CT—Court</div>
    <div class="legend-item shift-T">T—Training</div>
    <div class="legend-item shift-RDO">RDO—Off</div>
    <div class="legend-item shift-LSL">LSL—Long Service</div>
    <div class="legend-item shift-RS">RS—Regional Shield</div>
  </div>

  <div class="controls">
    <label>Team:
      <select id="teamFilter"><option value="">All</option></select>
    </label>
    <label>Emp No:
      <input id="empFilter" type="text" placeholder="e.g. 204140">
    </label>
    <label>Start:
      <input id="startDate" type="date">
    </label>
    <label>End:
      <input id="endDate" type="date">
    </label>
    <button id="reloadBtn">Reload</button>
  </div>

  <div id="status" style="text-align:center; font-weight:bold;"></div>
  <table>
    <thead id="thead"></thead>
    <tbody id="tbody"></tbody>
  </table>

<script>
(async()=>{
  // fetch & parse both spreadsheets
  const [rBuf, oBuf] = await Promise.all([
    fetch('roster_template_final.xlsx').then(r=>r.arrayBuffer()),
    fetch('overrides.xlsx').then(r=>r.arrayBuffer())
  ]);
  const rWb = XLSX.read(rBuf,{type:'array'}),
        oWb = XLSX.read(oBuf,{type:'array'}),
        roster = XLSX.utils.sheet_to_json(rWb.Sheets['Roster'],{header:1}),
        pattern = XLSX.utils.sheet_to_json(rWb.Sheets['RotationPattern'],{header:1}),
        overrides= XLSX.utils.sheet_to_json(oWb.Sheets[oWb.SheetNames[0]],{header:1});

  // map overrides for quick lookup
  const ovMap = {};
  overrides.slice(1).forEach(r=>{
    const [eno, date, code] = r;
    ovMap[`${eno}|${date}`] = code;
  });

  // Populate Team dropdown
  const teamSet = new Set(roster.slice(1).map(r=>r[3]));
  const teamSel = document.getElementById('teamFilter');
  teamSet.forEach(t=> teamSel.innerHTML += `<option>${t}</option>`);

  document.getElementById('reloadBtn').onclick = render;
  render();

  function render(){
    const hdr=roster[0], rows=roster.slice(1),
          team=teamSel.value, empFilter=document.getElementById('empFilter').value.trim(),
          sd=new Date(document.getElementById('startDate').value),
          ed=new Date(document.getElementById('endDate').value);

    // build date list from sd to ed
    if(isNaN(sd)|| isNaN(ed)) {
      document.getEleme
