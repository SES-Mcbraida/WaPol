<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Team Roster Viewer</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>

  <!--
  ============================================================================
    STYLES
  ============================================================================
  -->
  <style>
    /* ─── Page & Typography ───────────────────────────────────────────────── */
    body {
      font-family: Arial, sans-serif;
      background: #e6f0ff;    /* light blue */
      color: #003366;         /* dark blue */
      padding: 1rem;
    }
    h1 { text-align: center; margin-bottom: .5rem; }

    /* ─── Controls ─────────────────────────────────────────────────────────── */
    .controls {
      text-align: center;
      margin: 10px 0;
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 8px;
    }
    .controls label, .controls input, .controls select, .controls button {
      font-size: 0.9rem;
    }
    .controls input, .controls select, .controls button {
      padding: 4px 8px;
    }

    /* ─── Status & Table Container ────────────────────────────────────────── */
    #status {
      text-align: center;
      margin: 8px 0;
      font-weight: bold;
    }
    #table-container {
      overflow-x: auto;
    }

    /* ─── Table ───────────────────────────────────────────────────────────── */
    table {
      border-collapse: collapse;
      width: 100%;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 6px;
      text-align: center;
      font-size: 0.9rem;
    }
    th {
      background: #0059b3;
      color: #fff;
      position: sticky;
      top: 0;
      z-index: 2;
    }
    input.shift-input {
      width: 100%;
      border: none;
      background: transparent;
      text-align: center;
    }

    /* ─── Legend ──────────────────────────────────────────────────────────── */
    .legend {
      margin-top: 16px;
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      justify-content: center;
    }
    .legend-item {
      padding: 4px 8px;
      font-size: 0.8rem;
      border: 1px solid #aaa;
      border-radius: 4px;
    }

    /* ─── Shift Colour Classes ───────────────────────────────────────────── */
    .shift-6   { background: #d6f5d6; }  /* Day */
    .shift-15  { background: #cce5ff; }  /* Afternoon */
    .shift-16  { background: #99ccff; }  /* Late */
    .shift-17  { background: #e0ccff; }  /* Evening */
    .shift-18  { background: #f2f2f2; }  /* Night */
    .shift-X   { background: #ffcccb; }  /* Day Off */
    .shift-AL  { background: #fff7a0; }  /* Annual Leave */
    .shift-CT  { background: #ffc966; }  /* Court */
    .shift-T   { background: #d9b3ff; }  /* Training */
    .shift-RDO { background: #ffd6d6; }  /* RDO */
    .shift-LSL { background: #c2f0c2; }  /* Long Service */
    .shift-RS  { background: #b3e6ff; }  /* Regional Shield */
  </style>
</head>
<body>

  <!-- =================== HEADER =================== -->
  <h1>Team Roster Viewer</h1>

  <!-- =================== CONTROLS =================== -->
  <div class="controls">
    <!-- Preset dropdown -->
    <label for="preset">View:</label>
    <select id="preset">
      <option value="">-- Select --</option>
      <option value="week">Current Week</option>
      <option value="month">Current Month</option>
      <option value="next">Next Month</option>
    </select>

    <!-- Manual date range -->
    <label for="start-date">Start:</label>
    <input type="date" id="start-date" />
    <label for="end-date">End:</label>
    <input type="date" id="end-date" />

    <!-- ID filter -->
    <label for="id-filter">Filter ID:</label>
    <input type="text" id="id-filter" placeholder="Emp No." />

    <!-- Reload Excel -->
    <button id="refreshBtn">Reload Roster File</button>
  </div>

  <!-- Status messages -->
  <div id="status">Initializing…</div>

  <!-- Table will be injected here -->
  <div id="table-container"></div>

  <!-- =================== LEGEND =================== -->
  <div class="legend">
    <span class="legend-item shift-6">6 – Day</span>
    <span class="legend-item shift-15">15 – Afternoon</span>
    <span class="legend-item shift-16">16 – Late</span>
    <span class="legend-item shift-17">17 – Evening</span>
    <span class="legend-item shift-18">18 – Night</span>
    <span class="legend-item shift-AL">AL – Annual Leave</span>
    <span class="legend-item shift-CT">CT – Court</span>
    <span class="legend-item shift-T">T – Training</span>
    <span class="legend-item shift-RDO">RDO – Rostered Day Off</span>
    <span class="legend-item shift-LSL">LSL – Long Service</span>
    <span class="legend-item shift-RS">RS – Regional Shield</span>
    <span class="legend-item shift-X">X – Day Off</span>
  </div>

  <!-- =================== SCRIPTS =================== -->
  <!-- XLSX library for reading Excel in the browser -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script>
    /* ── Globals ────────────────────────────────────────────────────────── */
    let fullRoster = [];    // raw 2D array from Excel
    let canEdit = false;    // becomes true if correct password

    /* ── On Load: Ask password and fetch Excel ──────────────────────────── */
    window.addEventListener('load', () => {
      // simple prompt-based password gate
      const pwd = prompt("Enter edit password:");
      canEdit = (pwd === 'password');
      document.getElementById('status').innerText = canEdit
        ? "Edit mode enabled" : "Read-only mode";
      loadAndRender();  // initial fetch & render
    });

    /* ── Utility: map shift code to CSS class ────────────────────────── */
    function getShiftClass(val) {
      return 'shift-' + (val || '').toString().toUpperCase();
    }

    /* ── Core: filter + render based on active filters ───────────────── */
    function loadAndRender() {
      document.getElementById('status').innerText = canEdit
        ? "Loading (edit)…" : "Loading…";

      // Fetch with cache-bust
      fetch('roster_template_final.xlsx?cacheBust='+Date.now())
        .then(res => {
          if (!res.ok) throw new Error('File fetch failed: ' + res.status);
          return res.arrayBuffer();
        })
        .then(buf => {
          // parse workbook & get first sheet
          const wb = XLSX.read(buf, { type:'array' });
          fullRoster = XLSX.utils.sheet_to_json(
            wb.Sheets[wb.SheetNames[0]],
            { header:1 }
          );
          // apply filters & render
          applyFilters();
          document.getElementById('status').innerText = canEdit
            ? "Roster loaded (edit mode)" : "Roster loaded";
        })
        .catch(err => {
          document.getElementById('status').innerText = "❌ Error loading file";
          document.getElementById('table-container').innerText = err.message;
          console.error(err);
        });
    }

    /* ── Helper: builds and displays the table for a given 2D array ──── */
    function renderTable(data) {
      const container = document.getElementById('table-container');
      let html = '<table><thead><tr>';
      // headers
      data[0].forEach(h=> html += `<th>${h}</th>`);
      html += '</tr></thead><tbody>';
      // rows
      data.slice(1).forEach(row => {
        html += '<tr>';
        row.forEach((cell, idx) => {
          if (idx < 6) {
            html += `<td>${cell||''}</td>`;
          } else {
            const cls = getShiftClass(cell);
            html += `<td class="${cls}">
                       <input class="shift-input" value="${cell||''}"
                         ${canEdit ? '' : 'disabled'}
                         oninput="this.parentElement.className=getShiftClass(this.value)" />
                     </td>`;
          }
        });
        html += '</tr>';
      });
      html += '</tbody></table>';
      container.innerHTML = html;
    }

    /* ── Filter Logic: date range + ID search ──────────────────────────── */
    function applyFilters() {
      if (!fullRoster.length) return;  // nothing loaded yet
      const headers = fullRoster[0];
      const body = fullRoster.slice(1);

      // 1) Determine which date columns to keep
      const startVal = document.getElementById('start-date').value;
      const endVal   = document.getElementById('end-date').value;
      const preset   = document.getElementById('preset').value;
      let start, end;
      const today = new Date();

      // If preset chosen, override start/end
      if (preset==='week') {
        const d = today.getDay();
        start = new Date(today); start.setDate(today.getDate()-d);
        end   = new Date(start); end.setDate(start.getDate()+6);
      } else if (preset==='month') {
        start = new Date(today.getFullYear(), today.getMonth(),1);
        end   = new Date(today.getFullYear(), today.getMonth()+1,0);
      } else if (preset==='next') {
        start = new Date(today.getFullYear(), today.getMonth()+1,1);
        end   = new Date(today.getFullYear(), today.getMonth()+2,0);
      } else if (startVal && endVal) {
        start = new Date(startVal);
        end   = new Date(endVal);
      }

      // Identify date columns by header matching dd/mm
      const dateCols = headers.map((h,i) => {
        const m = h.match(/(\d{2})\/(\d{2})/);
        if (m) {
          const d = new Date(today.getFullYear(), +m[2]-1, +m[1]);
          return { idx:i, date:d };
        }
      }).filter(x=>x);

      // Filter for those within range
      let colIdxs = [];
      if (start && end) {
        colIdxs = dateCols
          .filter(c=>c.date>=start && c.date<=end)
          .map(c=>c.idx);
      } else {
        // If no date filtering, show all
        colIdxs = dateCols.map(c=>c.idx);
      }

      // 2) Filter rows by ID if provided
      const idFilter = document.getElementById('id-filter').value.trim();
      let filteredRows = body;
      if (idFilter) {
        filteredRows = filteredRows.filter(r =>
          r[1].toString().includes(idFilter)
        );
      }

      // 3) Build new data array: static cols + filtered date cols
      const newHdr  = headers.slice(0,6).concat(colIdxs.map(i=>headers[i]));
      const newBody = filteredRows.map(r =>
        r.slice(0,6).concat(colIdxs.map(i=>r[i]))
      );

      // 4) Render
      renderTable([newHdr, ...newBody]);
    }

    /* ── Event Hooks ───────────────────────────────────────────────────── */
    document.getElementById('refreshBtn').addEventListener('click', loadAndRender);
    ['preset','start-date','end-date','id-filter']
      .forEach(id => document.getElementById(id)
        .addEventListener('change', applyFilters)
      );

  </script>
</body>
</html>
