<script>
(async()=>{
  // 1) load the two workbooks
  const [rBuf, oBuf] = await Promise.all([
    fetch('roster_template_final.xlsx').then(r=>r.arrayBuffer()),
    fetch('overrides.xlsx').then(r=>r.arrayBuffer())
  ]);
  const rWb = XLSX.read(rBuf,{type:'array'}),
        oWb = XLSX.read(oBuf,{type:'array'}),
        roster  = XLSX.utils.sheet_to_json(rWb.Sheets['Roster'],{header:1}),
        pattern = XLSX.utils.sheet_to_json(rWb.Sheets['RotationPattern'],{header:1}),
        overrides= XLSX.utils.sheet_to_json(oWb.Sheets[oWb.SheetNames[0]],{header:1});

  // build override map
  const ovMap = {};
  overrides.slice(1).forEach(r=>{
    const [eno,date,code]=r;
    ovMap[`${eno}|${date}`]=code;
  });

  // fill Team dropdown
  const teams = [...new Set(roster.slice(1).map(r=>r[3]))];
  const teamSel = document.getElementById('teamFilter');
  teams.forEach(t=> teamSel.innerHTML += `<option>${t}</option>`);

  // default Start/End to this week (Mon→Sun)
  const sdInput = document.getElementById('startDate'),
        edInput = document.getElementById('endDate'),
        today   = new Date(),
        dow     = today.getDay(),          // 0=Sun,1=Mon...
        mon     = new Date(today), 
        sun     = new Date(today);
  // compute Monday
  mon.setDate(today.getDate() - ((dow+6)%7));
  sun.setDate(mon.getDate() + 6);
  sdInput.valueAsDate = mon;
  edInput.valueAsDate = sun;

  // wire up reload button and input changes
  document.getElementById('reloadBtn').onclick = render;
  sdInput .addEventListener('change', render);
  edInput .addEventListener('change', render);
  teamSel.addEventListener('change', render);
  document.getElementById('empFilter').addEventListener('input', render);

  // initial render
  render();

  function render(){
    const hdr = roster[0],
          rows= roster.slice(1),
          team= teamSel.value,
          empF= document.getElementById('empFilter').value.trim(),
          sd  = new Date(sdInput.value),
          ed  = new Date(edInput.value),
          statusEl = document.getElementById('status');

    // if dates invalid, show warning but still use this week's defaults
    if (isNaN(sd) || isNaN(ed)) {
      statusEl.innerText = '⚠️ Pick valid dates; showing current week';
      sdInput.valueAsDate = mon;
      edInput.valueAsDate = sun;
    } else {
      statusEl.innerText = '';
    }

    // build date array
    let dates = [];
    for (let d = new Date(sdInput.valueAsDate); d <= edInput.valueAsDate; d.setDate(d.getDate()+1)) {
      dates.push(new Date(d));
    }

    // render THEAD
    let thead = '<tr><th>Name</th><th>Emp No.</th><th>QUALIFICATIONS</th><th>Team</th>';
    dates.forEach(d=>{
      const dd=String(d.getDate()).padStart(2,'0'),
            mm=String(d.getMonth()+1).padStart(2,'0');
      thead += `<th>${dd}/${mm}</th>`;
    });
    thead += '</tr>';
    document.getElementById('thead').innerHTML = thead;

    // constants for week/day lookup
    const refMon = new Date(2025,5,30), // 30 Jun 2025
          msDay  = 1000*60*60*24,
          msWeek = msDay*7;

    // render TBODY
    let bodyHtml = '';
    rows
      .filter(r=> (!team|| r[3]==team) && (!empF|| r[1].toString().includes(empF)))
      .forEach(r=>{
        let tr = `<tr>
          <td>${r[0]}</td><td>${r[1]}</td><td>${r[2]}</td><td>${r[3]}</td>`;
        dates.forEach(d=>{
          const dd=String(d.getDate()).padStart(2,'0'),
                mm=String(d.getMonth()+1).padStart(2,'0'),
                iso=`2025-${mm}-${dd}`,
                ovKey = `${r[1]}|${iso}`,
                ov = ovMap[ovKey];

          let code = ov || '';
          if (!ov) {
            // calculate week index and day-of-week index
            const daysSince = Math.floor((d - refMon)/msDay),
                  wk  = (Math.floor(daysSince/7) % 5) + 1,
                  dow = d.getDay()==0?7:d.getDay(),  // 1=Mon…7=Sun
                  pat = pattern[wk][dow];
            code = pat;
          }
          tr += `<td class="shift-${code}">${code}</td>`;
        });
        tr += '</tr>';
        bodyHtml += tr;
      });

    document.getElementById('tbody').innerHTML = bodyHtml;
  }
})();
</script>
 
