<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Team Roster Viewer</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>

  <!--
    ======================
    CSS STYLES
    ======================
    * Sets overall page look: font, background, color, padding
    * Styles controls, status, table, inputs, legend
    * Defines colour classes for each shift code
  -->
  <style>
    /* Page layout */
    body {
      font-family: Arial, sans-serif;
      background: #e6f0ff;       /* soft light blue */
      color: #003366;            /* dark blue text */
      padding: 1rem;
    }
    h1 { text-align: center; }

    /* Controls (dropdown + button) */
    .controls { text-align: center; margin-bottom: 1rem; }
    select, button { padding: 5px; font-size: 0.9rem; margin: 0 5px; }

    /* Status line below controls */
    #status {
      text-align: center;
      margin: 10px 0;
      font-weight: bold;
    }

    /* Table: sticky headers, borders, scrolling */
    table {
      border-collapse: collapse;
      width: 100%;
      overflow-x: auto;
      display: block;
    }
    th, td {
      padding: 8px;
      border: 1px solid #ccc;
      text-align: center;
      font-size: 0.9rem;
    }
    th {
      background: #0059b3;      /* navy header */
      color: white;
      position: sticky;
      top: 0;
      z-index: 1;
    }

    /* Input cells for shifts */
    input.shift-input {
      width: 100%;
      border: none;
      background: transparent;
      text-align: center;
    }

    /* Legend area */
    .legend {
      margin-top: 20px;
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      justify-content: center;
    }
    .legend-item {
      padding: 5px 10px;
      font-size: 0.8rem;
      border-radius: 4px;
      border: 1px solid #ccc;
    }

    /* Shift colour classes */
    .shift-6   { background: #d6f5d6; }  /* Day */
    .shift-15  { background: #cce5ff; }  /* Afternoon */
    .shift-16  { background: #99ccff; }  /* Late */
    .shift-17  { background: #e0ccff; }  /* Evening */
    .shift-18  { background: #f2f2f2; }  /* Night */
    .shift-X   { background: #ffcccb; }  /* Day Off */
    .shift-AL  { background: #fff7a0; }  /* Annual Leave */
    .shift-CT  { background: #ffc966; }  /* Court */
    .shift-T   { background: #d9b3ff; }  /* Training */
    .shift-RDO { background: #ffd6d6; }  /* RDO */
    .shift-LSL { background: #c2f0c2; }  /* Long Service */
    .shift-RS  { background: #b3e6ff; }  /* Regional Shield */
  </style>
</head>
<body>

  <!-- Page Header -->
  <h1>Team Roster Viewer</h1>

  <!-- Controls -->
  <div class="controls">
    <label for="preset">View:</label>
    <select id="preset">
      <option value="">-- Select --</option>
      <option value="week">Current Week</option>
      <option value="month">Current Month</option>
      <option value="next">Next Month</option>
    </select>
    <button id="refreshBtn">Reload Roster File</button>
  </div>

  <!-- Status message -->
  <div id="status">Initializing…</div>
  <!-- Table goes here -->
  <div id="table-container"></div>

  <!-- Colour Legend -->
  <div class="legend">
    <span class="legend-item shift-6">6 – Day</span>
    <span class="legend-item shift-15">15 – Afternoon</span>
    <span class="legend-item shift-16">16 – Late</span>
    <span class="legend-item shift-17">17 – Evening</span>
    <span class="legend-item shift-18">18 – Night</span>
    <span class="legend-item shift-AL">AL – Annual Leave</span>
    <span class="legend-item shift-CT">CT – Court</span>
    <span class="legend-item shift-T">T – Training</span>
    <span class="legend-item shift-RDO">RDO – Rostered Day Off</span>
    <span class="legend-item shift-LSL">LSL – Long Service</span>
    <span class="legend-item shift-RS">RS – Regional Shield</span>
    <span class="legend-item shift-X">X – Day Off</span>
  </div>

  <!-- Include SheetJS library for Excel parsing -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script>
    // Global variables
    let fullRoster = [];  // holds entire sheet data
    let canEdit = false;  // set true if correct password entered

    // On page load: ask for password, then load the file
    window.addEventListener('load', () => {
      // Prompt for edit password
      const pwd = prompt("Enter edit password:");
      if (pwd === 'password') {
        canEdit = true;
        document.getElementById('status').innerText = "Edit mode enabled";
      } else {
        document.getElementById('status').innerText = "Read-only mode";
      }
      loadRosterFile();  // fetch and render the Excel data
    });

    /**
     * Maps a shift code to its CSS class.
     */
    function getShiftClass(val) {
      return 'shift-' + (val || '').toString().toUpperCase();
    }

    /**
     * Renders a 2D array `data` into an HTML table.
     * First row = headers, subsequent rows = data rows.
     */
    function renderTable(data) {
      const container = document.getElementById('table-container');
      let html = '<table><thead><tr>';

      // Build headers
      data[0].forEach(h => {
        html += `<th>${h}</th>`;
      });
      html += '</tr></thead><tbody>';

      // Build rows
      for (let i = 1; i < data.length; i++) {
        html += '<tr>';
        data[i].forEach((cell, j) => {
          // First 6 columns are static text
          if (j < 6) {
            html += `<td>${cell || ''}</td>`;
          } else {
            // Shift cells: colored + editable if allowed
            const cls = getShiftClass(cell);
            html += `<td class="${cls}">
                       <input class="shift-input" value="${cell||''}"
                              ${canEdit ? '' : 'disabled'}
                              oninput="this.parentElement.className=getShiftClass(this.value)" />
                     </td>`;
          }
        });
        html += '</tr>';
      }

      html += '</tbody></table>';
      container.innerHTML = html;
    }

    /**
     * Fetches the Excel file, parses it, stores into fullRoster,
     * and renders the full table.
     */
    function loadRosterFile() {
      const status = document.getElementById('status');
      status.innerText = canEdit ? "Loading file (edit)..." : "Loading file...";

      fetch('roster_template_final.xlsx?cacheBust=' + Date.now())
        .then(res => {
          if (!res.ok) throw new Error('File not found (' + res.status + ')');
          return res.arrayBuffer();
        })
        .then(buf => {
          const wb = XLSX.read(buf, { type: 'array' });
          fullRoster = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]], { header: 1 });
          renderTable(fullRoster);
          status.innerText = canEdit ? "Roster loaded (edit)" : "Roster loaded";
          document.getElementById('preset').value = '';
        })
        .catch(err => {
          document.getElementById('status').innerText = "❌ Error loading Excel";
          document.getElementById('table-container').innerText = err.message;
          console.error(err);
        });
    }

    /**
     * Filters fullRoster to only columns whose dates lie between start and end,
     * then renders that sub-table.
     */
    function loadRosterForDates(start, end) {
      const hdr = fullRoster[0];
      // Identify date columns by matching dd/mm
      const dateCols = hdr.map((h, i) => {
        const m = h.match(/(\d{2})\/(\d{2})/);
        if (m) {
          const d = new Date((new Date()).getFullYear(), +m[2] - 1, +m[1]);
          return { idx: i, date: d };
        }
      }).filter(x => x);

      // Select only those columns in the range
      const cols = dateCols.filter(c => c.date >= start && c.date <= end).map(c => c.idx);
      // Build new headers + rows
      const newHdr = hdr.slice(0,6).concat(cols.map(i => hdr[i]));
      const newRows = fullRoster.slice(1).map(r => r.slice(0,6).concat(cols.map(i => r[i])));
      renderTable([newHdr, ...newRows]);
    }

    // Bind UI events:
    document.getElementById('refreshBtn').onclick = loadRosterFile;
    document.getElementById('preset').onchange = function() {
      const now = new Date(), opt = this.value;
      let s, e;
      if (opt === 'week') {
        const d = now.getDay();
        s = new Date(now); s.setDate(now.getDate() - d);
        e = new Date(s); e.setDate(s.getDate() + 6);
      } else if (opt === 'month') {
        s = new Date(now.getFullYear(), now.getMonth(), 1);
        e = new Date(now.getFullYear(), now.getMonth()+1, 0);
      } else if (opt === 'next') {
        s = new Date(now.getFullYear(), now.getMonth()+1, 1);
        e = new Date(now.getFullYear(), now.getMonth()+2, 0);
      } else return;
      loadRosterForDates(s, e);
    };
  </script>
</body>
</html>
